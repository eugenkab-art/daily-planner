<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω—è</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body { 
            font-family: 'Arial', sans-serif; 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f8f5f0;
            min-height: 100vh;
        }
        .paper-container {
            background: #fffdf8;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #5d4037;
        }
        .header h1 {
            color: #5d4037;
            font-size: 28px;
            margin: 0;
        }
        .header button {
            background-color: #8d6e63;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        .header button:hover {
            background-color: #6d4c41;
        }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 15px;
            border: 1px dashed #e0d9d0;
            border-radius: 8px;
        }
        .input-group input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-group button {
            background-color: #4CAF50;
        }
        .input-group button:hover {
            background-color: #45a049;
        }

        /* –°–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á/–∑–∞–º–µ—Ç–æ–∫ */
        .list-section h2 {
            color: #5d4037;
            border-left: 5px solid #8d6e63;
            padding-left: 10px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #f0e9e1;
            border-radius: 6px;
            background-color: #fff;
            transition: all 0.2s;
        }
        li:hover {
            box-shadow: 0 2px 5px rgba(139, 115, 85, 0.1);
        }
        .task-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .task-text {
            margin-left: 10px;
            flex-grow: 1;
            font-size: 16px;
            color: #333;
        }
        .task-completed .task-text, .note-done .note-text {
            text-decoration: line-through;
            color: #a1887f;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            color: #cc0000;
            font-size: 18px;
            transition: color 0.2s;
        }
        .actions button:hover {
            color: #ff0000;
        }
    </style>
</head>
<body>

    <div class="paper-container">

        <div class="header">
            <button onclick="window.location.href='weekly.html'">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–µ–¥–µ–ª–µ</button>
            <h1 id="currentDateTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div></div> </div>

        <div class="input-group">
            <input type="text" id="taskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞/–∑–∞–º–µ—Ç–∫–∞">
            <button onclick="addTask()">+ –ó–∞–¥–∞—á–∞</button>
            <button onclick="addNote()" style="background-color: #FF9800;">+ –ó–∞–º–µ—Ç–∫–∞</button>
        </div>

        <div class="list-section">
            <h2>üìù –ó–∞–¥–∞—á–∏ (Tasks)</h2>
            <ul id="taskList">
                </ul>
        </div>

        <div class="list-section">
            <h2>üìå –ó–∞–º–µ—Ç–∫–∏ (Notes)</h2>
            <ul id="noteList">
                </ul>
        </div>

    </div>

    <script>
        // 1. –ö–û–ù–°–¢–ê–ù–¢–´
        const API_BASE_URL = "https://daily-planner-sj2y.onrender.com/api";
        const urlParams = new URLSearchParams(window.location.search);
        const currentDateStr = urlParams.get('date'); // –§–æ—Ä–º–∞—Ç YYYY-MM-DD

        // 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = 'index.html'; 
                return false;
            }
            return true;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–∞—Ç—ã
        function formatTitle(dateStr) {
            const date = new Date(dateStr + 'T00:00:00'); // –î–æ–±–∞–≤–ª—è–µ–º T00:00:00, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ru-RU', options);
        }

        // 3. –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–•
        async function loadData() {
            if (!checkAuth() || !currentDateStr) return;

            document.getElementById('currentDateTitle').textContent = formatTitle(currentDateStr);
            
            await loadTasks();
            await loadNotes();
        }

        // 4. CRUD: –ó–ê–î–ê–ß–ò
        
        async function loadTasks() {
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE_URL}/tasks?date=${currentDateStr}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) {
                    checkAuth(); // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç
                    return;
                }
                
                const tasks = response.ok ? await response.json() : [];
                renderTasks(tasks);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                document.getElementById('taskList').innerHTML = `<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</li>`;
            }
        }

        function renderTasks(tasks) {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            if (tasks.length === 0) {
                list.innerHTML = `<li>–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.</li>`;
                return;
            }

            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = task.completed ? 'task-completed' : '';
                li.innerHTML = `
                    <div class="task-content">
                        <input type="checkbox" 
                                ${task.completed ? 'checked' : ''} 
                                onclick="toggleTaskCompletion(${task.id}, ${!task.completed})">
                        <span class="task-text">${task.text}</span>
                    </div>
                    <div class="actions">
                        <button onclick="deleteTask(${task.id})">‚ùå</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text || !checkAuth()) return;

            const token = getAuthToken();
            input.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
            
            try {
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ text, date: currentDateStr })
                });

                if (response.ok) {
                    loadTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', await response.json());
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            }
        }

        async function toggleTaskCompletion(id, completed) {
            if (!checkAuth()) return;
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ completed })
                });

                if (response.ok) {
                    loadTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            }
        }

        async function deleteTask(id) {
            if (!checkAuth() || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', await response.json());
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            }
        }


        // 5. CRUD: –ó–ê–ú–ï–¢–ö–ò (–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∑–∞–¥–∞—á–∞–º)

        async function loadNotes() {
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE_URL}/notes?date=${currentDateStr}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) {
                    checkAuth();
                    return;
                }
                
                const notes = response.ok ? await response.json() : [];
                renderNotes(notes);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫:', error);
                document.getElementById('noteList').innerHTML = `<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</li>`;
            }
        }

        function renderNotes(notes) {
            const list = document.getElementById('noteList');
            list.innerHTML = '';
            
            if (notes.length === 0) {
                list.innerHTML = `<li>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.</li>`;
                return;
            }

            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = note.done ? 'note-done' : '';
                li.innerHTML = `
                    <div class="task-content">
                        <input type="checkbox" 
                                ${note.done ? 'checked' : ''} 
                                onclick="toggleNoteCompletion(${note.id}, ${!note.done})">
                        <span class="task-text">${note.text}</span>
                    </div>
                    <div class="actions">
                        <button onclick="deleteNote(${note.id})">‚ùå</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        async function addNote() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text || !checkAuth()) return;

            const token = getAuthToken();
            input.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
            
            try {
                const response = await fetch(`${API_BASE_URL}/notes`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ text, date: currentDateStr })
                });

                if (response.ok) {
                    loadNotes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', await response.json());
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏:', error);
            }
        }

        async function toggleNoteCompletion(id, done) {
            if (!checkAuth()) return;
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/notes/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ done })
                });

                if (response.ok) {
                    loadNotes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', error);
            }
        }

        async function deleteNote(id) {
            if (!checkAuth() || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) return;
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE_URL}/notes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadNotes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', await response.json());
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏:', error);
            }
        }


        // 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

</body>
</html>