<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f8f5f0;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(120, 119, 116, 0.03) 3px, transparent 0),
                radial-gradient(circle at 90% 80%, rgba(120, 119, 116, 0.02) 2px, transparent 0);
            background-size: 80px 80px, 60px 60px;
            min-height: 100vh;
        }
        
        .paper-container {
            background: #fffdf8;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 
                0 8px 25px rgba(139, 115, 85, 0.15),
                0 0 0 1px rgba(139, 115, 85, 0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #c0b9af;
        }
        
        .header button {
            background: none;
            border: 1px solid #e0d9d0;
            color: #5d4037;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .header h1 {
            color: #5d4037;
            font-size: 24px;
            margin: 0;
            text-align: center;
        }
        
        .week-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }
        
        .day-box {
            background: #f7f3ed;
            border: 1px solid #e0d9d0;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(139, 115, 85, 0.05);
        }
        
        .day-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(139, 115, 85, 0.1);
            background: #fff;
        }

        .day-name {
            font-size: 14px;
            color: #8d6e63;
            margin-bottom: 5px;
            border-bottom: 1px solid #f0e9e1;
            padding-bottom: 5px;
        }

        .day-number {
            font-size: 28px;
            font-weight: bold;
            color: #5d4037;
            margin-bottom: 10px;
        }

        .task-count {
            font-size: 12px;
            color: #a1887f;
            padding: 5px 0;
            border-top: 1px dashed #e0d9d0;
        }
    </style>
</head>
<body>

    <div class="paper-container">
        
        <div class="header">
            <button id="prevWeekBtn">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <h1 id="currentMonthYear">...</h1>
            <button id="nextWeekBtn">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
        </div>

        <div class="week-container" id="weekContainer">
            </div>

    </div>

    <script>
        // 1. URL –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Render
        const API_BASE_URL = "https://daily-planner-sj2y.onrender.com/api";

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                window.location.href = 'index.html'; 
                return false;
            }
            console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.");
            return true;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
        function getWeekDates(startDate = new Date()) {
            const dates = [];
            const startOfWeek = new Date(startDate);
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (1)
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + (startOfWeek.getDay() === 0 ? -6 : 1)); 

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        const dayNames = ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"];
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

        function renderWeek(dates) {
            const container = document.getElementById('weekContainer');
            container.innerHTML = ''; 

            const currentMonthYear = `${monthNames[dates[0].getMonth()]} ${dates[0].getFullYear()}`;
            document.getElementById('currentMonthYear').textContent = currentMonthYear;

            dates.forEach((date, index) => {
                const day = date.getDay();
                const dayName = dayNames[day];
                const dayOfMonth = date.getDate();
                // –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è URL: YYYY-MM-DD
                const dateStr = date.toISOString().split('T')[0];
                
                const dayBox = document.createElement('div');
                dayBox.className = 'day-box';
                
                // –ö–ª–∏–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–Ω—è
                dayBox.onclick = () => {
                    window.location.href = `day.html?date=${dateStr}`;
                };

                dayBox.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-number">${dayOfMonth}</div>
                    <div class="task-count">–ó–∞–¥–∞—á: <span id="taskCount-${index}">...</span></div>
                `;
                container.appendChild(dayBox);

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–¥–∞—á
                loadTaskCount(date, index);
            });
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è API.
         */
        async function loadTaskCount(date, index) {
            if (!checkAuth()) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

            const token = getAuthToken();
            const dateStr = date.toISOString().split('T')[0];
            
            try {
                // –ó–∞–ø—Ä–æ—Å –∫ —Ä–∞–±–æ—á–µ–º—É API /api/tasks (–∏—Å–ø–æ–ª—å–∑—É–µ–º API_BASE_URL)
                const response = await fetch(`${API_BASE_URL}/tasks?date=${dateStr}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const countElement = document.getElementById(`taskCount-${index}`);

                if (response.ok) {
                    const tasks = await response.json();
                    countElement.textContent = tasks.length;
                } else if (response.status === 401 || response.status === 403) {
                    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —á–∏—Å—Ç–∏–º –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    localStorage.removeItem('authToken');
                    window.location.href = 'index.html';
                } else {
                    countElement.textContent = '–û—à–∏–±–∫–∞';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                document.getElementById(`taskCount-${index}`).textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞';
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
        let currentWeekStart = new Date();

        document.getElementById('prevWeekBtn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderWeek(getWeekDates(currentWeekStart));
        });

        document.getElementById('nextWeekBtn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderWeek(getWeekDates(currentWeekStart));
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–µ–¥–µ–ª–∏
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                renderWeek(getWeekDates());
            }
        });
    </script>
</body>
</html>